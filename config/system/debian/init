#!/usr/bin/env bash
set -euo pipefail

# ===== UI =====
BOLD="\033[1m"; RESET="\033[0m"
RED="\033[31m"; GREEN="\033[32m"; YELLOW="\033[33m"; CYAN="\033[36m"
info()  { printf "%b %s\n" "${BOLD}${CYAN}INFO\t:\t${RESET}"  "$*"; }
ok()    { printf "%b %s\n" "${BOLD}${GREEN}OK\t:\t${RESET}"   "$*"; }
warn()  { printf "%b %s\n" "${BOLD}${YELLOW}WARN\t:\t${RESET}" "$*"; }
error() { printf "%b %s\n" "${BOLD}${RED}ERROR\t:\t${RESET}"  "$*"; }
rule()  { printf "%s\n" "---------------------------------------------------------------------"; }
die()   { error "$*"; exit 1; }
run() {
  local msg="$1"; shift
  info "$msg"
  if ! "$@" > /dev/null 2>&1; then
    error "Failed: $msg"
    return 1
  fi
  ok "$msg"
}

dir=$1

# ===== Checking privileges =====
if [ "${EUID:-$(id -u)}" -eq 0 ]; then
  error "Do not run this script as root. Use a regular user with sudo."
  exit 1
else
  info "Running as regular user. sudo may prompt for password."
fi

# ===== APT =====

packages=(
  libxcb-xinerama0-dev
  libxcb-icccm4-dev
  libxcb-randr0-dev
  libxcb-util0-dev
  libxcb-ewmh-dev
  libxcb-keysyms1-dev
  libxcb-shape0-dev
  xserver-xorg-core
  xinit x11-xserver-utils
  mesa-utils
  bspwm
  sxhkd
  polybar
  rofi
  jq
  kitty
  xclip
  vim
  lightdm
  lightdm-gtk-greeter
  feh
)

export DEBIAN_FRONTEND=noninteractive
run "Updating APT package index" sudo apt-get update -qq
run "Upgrading system packages" sudo apt-get dist-upgrade -y
run "Removing unused packages" sudo apt-get autoremove -y
run "Installing prerequisites" sudo apt-get install -y ${packages[@]}

# ===== BSPWM =====


sudo cp -r $dir/shared/bspwm ~/.config/bspwm
sudo cp -r $dir/shared/sxhkd ~/.config/sxhkd
chmod u+x ~/.config/bspwm/bspwmrc

# ===== POLYBAR =====

sudo cp -r $dir/shared/polybar ~/.config/polybar
sudo cp -r $dir/shared/polybar/modules ~/.config/polybar/modules
chmod u+x ~/.config/polybar/launch.sh
chmod u+x ~/.config/polybar/modules/*

cat << EOF >> ~/.xinitrc
exec bspwm
EOF
chmod u+x ~/.xinitrc

sudo chownd -R $USER:$USER ~/.config

# ===== LIGHTDM =====

sudo cp $dir/shared/utils/lightdm-gtk-greeter.conf /etc/lightdm/lightdm-gtk-greeter.conf
sudo cp $dir/shared/img/wallpaper.jpg /usr/share/backgrounds/wallpaper.jpg

sudo systemctl enable lightdm > /dev/null 2>&1 || true
sudo systemctl start lightdm > /dev/null 2>&1 || true
